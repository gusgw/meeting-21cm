<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>21cmFAST Performance Profiling System</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/theme/white.css">

    <!-- Custom styling for better readability -->
    <style>
        .reveal {
            font-family: "Source Sans Pro", Helvetica, sans-serif;
            font-size: 38px;
            color: #222;
        }
        .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
            color: #222;
            text-transform: none;
            line-height: 1.2;
        }
        .reveal h1 {
            font-size: 2.5em;
        }
        .reveal h2 {
            font-size: 1.8em;
        }
        .reveal h3 {
            font-size: 1.3em;
        }
        .reveal pre {
            font-size: 0.55em;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.15);
        }
        .reveal code {
            font-family: "Source Code Pro", monospace;
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .reveal pre code {
            background-color: transparent;
            padding: 0;
        }
        .reveal ul {
            display: block;
            margin-left: 1em;
        }
        .reveal .slides section {
            text-align: left;
        }
        .reveal .slides section h1,
        .reveal .slides section h2,
        .reveal .slides section h3 {
            text-align: center;
        }
        .center {
            text-align: center !important;
        }
        .highlight {
            color: #2a76dd;
            font-weight: bold;
        }
        img.plot {
            max-width: 90%;
            max-height: 500px;
            display: block;
            margin: 0 auto;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">

            <!-- Slide 1: Title -->
            <section>
                <h1>21cmFAST Performance Profiling System</h1>
                <h3 style="color: #555;">Automated Job Submission and Analysis</h3>
                <br>
                <p class="center">A comprehensive framework for benchmarking and optimizing<br>21cmFAST simulations on HPC systems</p>
                <br>
                <p class="center" style="font-size: 0.7em; color: #777;">
                    ADACS Optimization Project<br>
                    September 2025
                </p>
            </section>

            <!-- Slide 2: Overview of Job Scripts -->
            <section>
                <h2>Job Scripts Overview</h2>
                <br>
                <h3>Script Architecture</h3>
                <ul>
                    <li><strong>5 Calculation Scripts</strong> in <code>script/</code>:
                        <ul style="font-size: 0.9em;">
                            <li><code>coeval_basic.py</code> - Basic coeval simulations</li>
                            <li><code>coeval_advanced.py</code> - Advanced coeval with custom parameters</li>
                            <li><code>lightcone.py</code> - Lightcone calculations</li>
                            <li><code>lightcone_production.py</code> - Production lightcones with visualization</li>
                            <li><code>run_new.py</code> - Modern API demonstration</li>
                        </ul>
                    </li>
                    <li><strong>2 Infrastructure Scripts</strong>:
                        <ul style="font-size: 0.9em;">
                            <li><code>cpu.sh</code> - Generic runner with profiling support</li>
                            <li><code>profile.sh</code> - Batch submission orchestrator</li>
                        </ul>
                    </li>
                    <li><strong>1 Analysis Script</strong>:
                        <ul style="font-size: 0.9em;">
                            <li><code>plot.py</code> - Visualization of timing and profile data</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <!-- Slide 3: cpu.sh Script Details -->
            <section>
                <h2>cpu.sh: The Execution Engine</h2>
                <br>
                <h3>Key Features</h3>
                <ul>
                    <li><span class="highlight">Environment Variables</span> for configuration:
                        <pre><code class="bash">PY21C_SCRIPT    # Python script to run
PY21C_VENV      # Virtual environment
PY21C_CPROFILE  # Enable/disable profiling
PY21C_TAG       # Tag for organizing results
PY21C_DRY_RUN   # Test without execution</code></pre>
                    </li>
                    <li><span class="highlight">Isolated Execution</span>: Copies scripts to unique directories</li>
                    <li><span class="highlight">Profiling Integration</span>: Optional cProfile with minimal overhead</li>
                    <li><span class="highlight">Comprehensive Logging</span>: Execution times, environment info, git commits</li>
                </ul>

                <h3>Output Structure</h3>
                <pre><code class="bash">work/run/[script]/[tag]-[timestamp]-[jobid]/
    ├── *.py          # Copied scripts
    ├── *.h5          # Simulation outputs
    └── *.pdf         # Visualization outputs</code></pre>
            </section>

            <!-- Slide 4: profile.sh Batch Submission -->
            <section>
                <h2>profile.sh: Batch Job Orchestration</h2>
                <br>
                <h3>Automated Submission</h3>
                <pre><code class="bash">./script/profile.sh -n 5 -t baseline</code></pre>

                <p>Submits <strong>50 jobs total</strong>:</p>
                <ul>
                    <li>5 scripts × 2 modes (profiled/unprofiled) × 5 runs each</li>
                    <li>Tagged results: <code>baseline-prof-*</code> and <code>baseline-noprof-*</code></li>
                </ul>

                <h3>Performance Comparison Workflow</h3>
                <ol>
                    <li><strong>Baseline Run</strong>: <code>profile.sh -n 5 -t baseline</code></li>
                    <li><strong>Modify Code/Flags</strong>: Change optimization settings</li>
                    <li><strong>Test Run</strong>: <code>profile.sh -n 5 -t optimized</code></li>
                    <li><strong>Analyze</strong>: <code>plot.py baseline optimized</code></li>
                </ol>

                <p style="font-size: 0.8em; margin-top: 20px;">
                    <span class="highlight">Result Files</span>:
                    <code>*.result.txt</code> (timing) and <code>*.profile</code> (cProfile data)
                </p>
            </section>

            <!-- Slide 5: Execution Times Plot -->
            <section>
                <h2>Execution Time Analysis</h2>
                <br>
                <p class="center">Comparing <code>run0</code> vs <code>run1</code> Performance</p>
                <br>
                <img src="../plot/execution_times_run0_run1.png" alt="Execution Times Comparison" class="plot"
                     onerror="this.onerror=null; this.src='placeholder_execution.png'; this.alt='Example: Execution times comparison plot showing box plots for each script, comparing profiled vs unprofiled runs across different tags';">
                <br>
                <ul style="font-size: 0.8em;">
                    <li>Box plots show distribution across multiple runs</li>
                    <li>Profiling overhead typically 5-15%</li>
                    <li>Identifies performance variations and outliers</li>
                </ul>
            </section>

            <!-- Slide 6: Profile Comparison Plot -->
            <section>
                <h2>Profile Analysis: run_new.py</h2>
                <br>
                <p class="center">Top 10 Most Time-Consuming Functions</p>
                <br>
                <img src="../plot/profile_run_new.png" alt="Profile Comparison for run_new.py" class="plot"
                     onerror="this.onerror=null; this.src='placeholder_profile.png'; this.alt='Example: Profile comparison showing horizontal box plots of cumulative time for top functions, comparing run0 vs run1';">
                <br>
                <ul style="font-size: 0.8em;">
                    <li>Identifies performance bottlenecks</li>
                    <li>Tracks optimization impact on specific functions</li>
                    <li>Guides targeted optimization efforts</li>
                </ul>
                <p style="font-size: 0.7em; color: #666; margin-top: 20px;" class="center">
                    Compiler flags tested: <code>-Ofast</code> → <code>-Ofast -march=native</code>
                </p>
            </section>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.js"></script>
    <script>
        Reveal.initialize({
            hash: true,
            controls: true,
            progress: true,
            center: false,
            transition: 'slide'
        });
    </script>
</body>
</html>